<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LUMI ‚Äì Call Simulator</title>

<style>
  :root{
    --bg:#05070b;
    --panel-bg:rgba(15,25,35,.85);
    --panel-bg-soft:rgba(15,25,35,.6);
    --border-subtle:rgba(124,211,255,.25);
    --border-strong:rgba(124,211,255,.6);
    --text-main:#eaf4ff;
    --text-soft:#8ea7c2;
    --accent:#7cd3ff;
  }

  html{
    margin:0;
    height:100%;
  }

  body{
    margin:0;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    background:radial-gradient(circle at top, #101b2b 0%, #0a111c 45%, #05070b 75%, #020308 100%);
    color:var(--text-main);
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow-x:hidden;
  }

  /* ----- HEADER ----- */
  .header-wrap {
    width:100%;
    padding:20px 24px 0;
    box-sizing:border-box;
    transition:opacity .8s ease, transform .8s ease;
  }

  .header {
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr auto 1fr;
    align-items:center;
  }

  .header-left { display:flex; justify-content:flex-start; }
  .header-center { display:flex; justify-content:center; }
  .header-right { display:flex; justify-content:flex-end; }

  .logo,
  .amazon-logo{
    width:auto;
    display:inline-block;
    transition:opacity .8s ease, transform .8s ease, filter .3s ease;
  }

  .logo{
    height:150px;
    filter:
      brightness(2.6)
      drop-shadow(0 0 26px rgba(120,200,255,1))
      drop-shadow(0 0 55px rgba(160,120,255,.9));
  }

  .amazon-logo{
    height:100px;
    opacity:.9;
    filter:
      brightness(2.1)
      drop-shadow(0 0 16px rgba(120,200,255,.7));
  }

  .logo:hover,
  .amazon-logo:hover{
    filter:
      brightness(3)
      drop-shadow(0 0 30px rgba(120,200,255,1))
      drop-shadow(0 0 65px rgba(160,120,255,.95));
    transform: translateY(-1px);
  }

  .icon-button{
    background:transparent;
    border:1px solid rgba(124,211,255,.4);
    border-radius:999px;
    color:var(--text-main);
    padding:10px 14px;
    display:flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    font-size:13px;
    transition:opacity .8s ease, transform .8s ease;
  }

  .icon-button span{
    font-size:18px;
    line-height:1;
  }

  .menu-panel{
    position:absolute;
    right:24px;
    top:56px;
    min-width:180px;
    background:var(--panel-bg);
    border-radius:14px;
    border:1px solid var(--border-subtle);
    box-shadow:0 18px 45px rgba(0,0,0,.65);
    padding:8px 0;
    display:none;
    z-index:50;
  }
  .menu-panel.open{ display:block; }

  .menu-item{
    padding:8px 14px;
    font-size:13px;
    cursor:pointer;
  }
  .menu-item:hover{
    background:rgba(120,200,255,.12);
  }

  /* ----- MAIN LAYOUT ----- */
  .app{
    flex:1;
    display:grid;
    grid-template-columns: minmax(300px, 340px) minmax(520px, 1fr) minmax(300px, 340px);
    gap:24px;
    align-items:flex-start;
    padding:16px 24px 24px;
    max-width:1400px;
    width:100%;
    margin:0 auto;
    box-sizing:border-box;
    transition:opacity .8s ease, transform .8s ease;
  }

  .col{ min-width:0; transition:opacity .8s ease, transform .8s ease; }

  @media(max-width:960px){
    .app{
      grid-template-columns:1fr;
    }
  }

  /* ----- STAGE + SPHERE ----- */
  .stage{
    display:flex;
    justify-content:center;
    align-items:flex-start;
    margin-top:12px;
    transition:min-height .8s ease;
  }

  .sphere-wrapper{
    position:relative;
    display:inline-block;
    transition:transform .9s ease;
  }

  #fog{
    width:min(520px,90vw);
    height:min(520px,90vw);
    display:block;
    filter:drop-shadow(0 20px 60px rgba(124,211,255,.25));
  }

  .sphere-logo{
    position:absolute;
    inset:0;
    margin:auto;
    height:140px;
    filter:
      invert(1)
      drop-shadow(0 0 35px rgba(180,220,255,1))
      drop-shadow(0 0 70px rgba(180,140,255,.95));
    opacity:0;
    pointer-events:none;
    transition: opacity .3s ease;
  }

  .center-controls{
    margin-top:4px;
    transition:opacity .8s ease, transform .8s ease;
  }

  /* ----- BUTTONS & PANELS ----- */
  .row{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    margin-top:10px;
    flex-wrap:wrap;
  }
  .row-space{ justify-content:space-between; }
  .row-left{ justify-content:flex-start; }

  button{
    background:#17324d;
    border:1px solid rgba(124,211,255,.45);
    color:#dff1ff;
    border-radius:12px;
    padding:10px 14px;
    cursor:pointer;
    font-size:13px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    transition: box-shadow .2s ease, border-color .2s ease, transform .2s ease, background-color .2s ease;
  }

  button[disabled]{ opacity:.6; cursor:not-allowed; }

  button:hover:not([disabled]),
  button:focus-visible:not([disabled]) {
    box-shadow:
      0 0 20px rgba(130,180,255,1),
      0 0 45px rgba(160,120,255,0.9),
      0 0 70px rgba(160,120,255,0.7);
    border-color: rgba(180,220,255,1);
    background: #21486f;
    transform: translateY(-1px);
  }

  button:active:not([disabled]) {
    transform: translateY(0);
    box-shadow:
      0 0 8px rgba(130,180,255,.7),
      0 0 18px rgba(140,120,255,.45);
  }

  .btn-ghost{
    background:transparent;
    border-style:dashed;
  }

  .btn-pill{
    border-radius:999px;
    padding-inline:12px;
    font-size:12px;
  }
  .btn-pill.active{
    background:rgba(124,211,255,.2);
    border-color:var(--border-strong);
  }

  .controls-label{
    font-size:12px;
    color:var(--text-soft);
    margin-right:6px;
    white-space:nowrap;
  }

  .panel{
    border:1px solid var(--border-subtle);
    border-radius:14px;
    background:var(--panel-bg);
    padding:14px 14px 12px;
  }

  .panel-soft{
    background:var(--panel-bg-soft);
  }

  .panel h3{
    margin:0 0 6px 0;
    font-size:14px;
  }

  .panel-subtitle{
    margin:0;
    font-size:11px;
    color:var(--text-soft);
  }

  .select{
    border-radius:10px;
    padding:7px 10px;
    border:1px solid var(--border-subtle);
    background:rgba(12,22,32,.85);
    color:var(--text-main);
    font-size:12px;
    min-width:200px;
  }

  .text-input{
    flex:1;
    min-width:220px;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--border-subtle);
    background:rgba(12,22,32,.85);
    color:var(--text-main);
    font-size:13px;
    outline:none;
  }

  .box{
    min-height:120px;
    max-height:300px;
    white-space:pre-wrap;
    background:rgba(10,18,28,.7);
    border:1px solid rgba(124,211,255,.18);
    border-radius:10px;
    padding:6px 10px;
    font-size:13px;
    line-height:1.2;
    overflow-y:auto;
  }

  .box-compact{
    min-height:60px;
    max-height:160px;
    font-size:12px;
    opacity:.9;
  }

  .box-chat{
    white-space:normal !important;
    line-height:1.2 !important;
  }

  /* Chat spacing */
  #dialogueTranscript {
    padding-top: 6px !important;
    padding-bottom: 6px !important;
  }
  .msg {
    margin: 0 0 6px 0 !important;
    padding: 0 !important;
  }
  .msg-role {
    margin: 0 0 2px 0 !important;
    padding: 0 !important;
    line-height: 1.1 !important;
    font-weight:600;
    font-size:11px;
  }
  .msg-role.lumi{ color:#9ee2ff; }
  .msg-role.am{ color:#f7d38c; }
  .msg-role.system{ color:#8ea7c2; }
  .msg-body {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1.15 !important;
    font-size:12px;
  }

  /* scrollbars */
  .box, .box-chat, .box-compact {
    scrollbar-width: thin;
    scrollbar-color: rgba(124,211,255,0.25) rgba(20,30,45,0.4);
  }
  .box::-webkit-scrollbar,
  .box-chat::-webkit-scrollbar,
  .box-compact::-webkit-scrollbar {
    width: 8px;
  }
  .box::-webkit-scrollbar-track,
  .box-chat::-webkit-scrollbar-track,
  .box-compact::-webkit-scrollbar-track {
    background: rgba(12,22,32,0);
    border-radius: 10px;
  }
  .box::-webkit-scrollbar-thumb,
  .box-chat::-webkit-scrollbar-thumb,
  .box-compact::-webkit-scrollbar-thumb {
    background: linear-gradient(
      to bottom,
      rgba(124,211,255,0.35),
      rgba(160,120,255,0.35)
    );
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.05);
    box-shadow: 0 0 12px rgba(124,211,255,0.4);
  }

  /* ===== SESSION SCORE UI ===== */
/* ===== SESSION SCORE UI ===== */
.score-layout{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.score-main{
  display:flex;
  align-items:center;
  gap:18px;
  margin-bottom:8px;
}

/* --- circular score (CSS-only ring using --score) --- */
.score-ring{
  --score: 0; /* 0‚Äì100, set by JS */
  position:relative;
  width:140px;
  height:140px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
}

/* the actual ring */
.score-ring::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  background:
    /* foreground arc + background track */
    conic-gradient(
      from -90deg,
      #7cd3ff 0deg,
      #a88cff calc(var(--score) * 3.6deg),
      rgba(124,211,255,0.18) calc(var(--score) * 3.6deg),
      rgba(124,211,255,0.18) 360deg
    );
  /* cut out the donut hole */
  -webkit-mask:
    radial-gradient(farthest-side,
      transparent calc(100% - 16px),
      #000        calc(100% - 12px));
  mask:
    radial-gradient(farthest-side,
      transparent calc(100% - 16px),
      #000        calc(100% - 12px));
  box-shadow:0 0 24px rgba(124,211,255,0.45);
}

/* number + label in the middle */
.score-number{
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:1;
}

#scoreRingValue{
  font-size:32px;
  line-height:1;
}

.score-max{
  font-size:12px;
  color:var(--text-soft);
  margin-top:2px;
}

.score-label{
  margin-top:6px;
  font-size:11px;
  color:var(--accent);
}

/* summary text to the right of the ring */
.score-summary{
  margin:0;
  font-size:12px;
  color:var(--text-soft);
  text-align:left;
  max-width:260px;
}

/* sub-score bars */
.score-bars{
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:11px;
}
.score-row{
  display:grid;
  grid-template-columns: minmax(120px, 1fr) 1fr auto;
  align-items:center;
  gap:8px;
}
.score-row-label{
  color:var(--text-soft);
}
.score-bar{
  width:100%;
}
.score-bar-track{
  width:100%;
  height:8px;
  border-radius:999px;
  background:rgba(12,22,32,0.95);
  overflow:hidden;
}
.score-bar-fill{
  height:100%;
  border-radius:999px;
  width:0;
  transition:width .9s ease;
  background:linear-gradient(90deg,#7cd3ff,#a88cff);
}
.score-row-value{
  width:48px;
  text-align:right;
  font-size:10px;
  color:var(--text-soft);
}

/* wins / next steps */
.score-feedback-columns{
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  margin-top:4px;
}
.score-column{
  flex:1 1 180px;
}
.score-column h4{
  margin:0 0 6px 0;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:.05em;
}
.score-column:first-child h4{ color:#8ecfff; }
.score-column:last-child h4{ color:#ffb4f8; }

.score-column ul{
  margin:0;
  padding-left:16px;
  font-size:12px;
  line-height:1.3;
}
.score-column li{
  margin-bottom:2px;
}


  /* ----- FOOTER ----- */
  .footer{
    max-width:1200px;
    margin:8px auto 16px;
    padding:0 24px;
    font-size:11px;
    color:var(--text-soft);
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    border-top:1px solid rgba(124,211,255,0.03);
    padding-top:8px;
    transition:opacity .8s ease, transform .8s ease;
  }

  /* ================== INTRO STATE ================== */

  body.intro .header-wrap,
  body.intro .footer{
    opacity:0;
    transform:translateY(-20px);
    pointer-events:none;
  }

  body.intro .amazon-logo,
  body.intro .header-center .logo,
  body.intro .header-right .icon-button{
    opacity:0;
    transform:translateY(-10px);
    pointer-events:none;
  }

  body.intro .app{
    opacity:1;
  }

  body.intro .col-left,
  body.intro .col-right{
    opacity:0;
    transform:translateY(20px);
    pointer-events:none;
  }

  body.intro .center-controls{
    opacity:0;
    transform:translateY(10px);
    pointer-events:none;
  }

  body.intro .sphere-logo{
    opacity:1;
    transform:scale(1.05);
  }

  body.intro .sphere-wrapper {
    margin-top: 40px;
  }

  .sphere-wrapper.intro-pulse {
    animation: introPulse 4s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
    transform-origin: center center;
  }

  @keyframes introPulse {
    0% {   transform: scale(1.4); }
    20% {  transform: scale(1.55); }
    40% {  transform: scale(1.45); }
    60% {  transform: scale(1.52); }
    80% {  transform: scale(1.42); }
    100% { transform: scale(1.0); }
  }

</style>
</head>
<body class="intro">

<!-- HEADER -->
<div class="header-wrap">
  <div class="header">
    <div class="header-left">
      <img src="orinoco.png" alt="Amazon logo" class="amazon-logo" />
    </div>
    <div class="header-center">
      <img src="logo.png" alt="LUMI logo" class="logo" />
    </div>
    <div class="header-right" style="position:relative;">
      <button id="menuBtn" class="icon-button" aria-label="Open menu">
        <span>‚ò∞</span> Menu
      </button>
      <div id="menuPanel" class="menu-panel">
        <div class="menu-item">Dashboard</div>
        <div class="menu-item">Session history</div>
        <div class="menu-item">Skill library</div>
        <div class="menu-item">Team viewing</div>
        <div class="menu-item">Settings</div>
        <div class="menu-item">Help & FAQ</div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app">

  <!-- LEFT: controls + selections -->
  <div class="col col-left">
    <div class="panel panel-soft">
      <h3>Call controls</h3>
      <p class="panel-subtitle">Prototype controls for this seller scenario.</p>

      <div class="row">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="pauseBtn">‚è∏ Pause</button>
        <button id="restartBtn">‚èÆ Restart</button>
      </div>

      <div class="row">
        <button id="hintBtn" class="btn-ghost">üí° Give me a hint</button>
        <button id="answerBtn" class="btn-ghost">‚ú® Answer for me</button>
      </div>

      <div class="row row-left" style="margin-top:14px;">
        <span class="controls-label">Difficulty</span>
        <button class="btn-pill difficulty-btn active" data-level="easy">Easy</button>
        <button class="btn-pill difficulty-btn" data-level="medium">Medium</button>
        <button class="btn-pill difficulty-btn" data-level="hard">Hard</button>
        <button class="btn-pill difficulty-btn" data-level="surprise">Surprise me</button>
      </div>

      <div class="row row-left" style="margin-top:12px;">
        <span class="controls-label">Pick your seller</span>
        <select id="personaSelect" class="select">
          <option>Ada Lovell ‚Äì Curious lifestyle brand founder (F)</option>
          <option>Grace Harper ‚Äì Structure-focused COO who likes clear plans (F)</option>
          <option>Kathleen Boothman ‚Äì Senior Amazon channel lead at a large consumer brand (F)</option>
          <option>Alan Turinger ‚Äì ROI-focused logic puzzle and games operator (M)</option>
          <option>Linus Torvaldsen ‚Äì Hands-on private-label power tools operator (M)</option>
          <option>Jeff River ‚Äì Visionary, customer-obsessed book brand founder (M)</option>
        </select>
      </div>

      <div class="row row-left" style="margin-top:12px;">
        <span class="controls-label">Topic</span>
        <select id="topicSelect" class="select">
          <option>ESM-Free pitch</option>
          <option>SAS pitch</option>
          <option>FBA optimisation</option>
          <option>Black Friday deals</option>
        </select>
      </div>
    </div>
  </div>

  <!-- CENTER: orb + mic -->
  <div class="col col-center">
    <div class="stage">
      <div class="sphere-wrapper">
        <canvas id="fog" width="520" height="520"></canvas>
        <img src="logo.png" class="sphere-logo" />
      </div>
    </div>
    <div class="center-controls">
      <div class="row">
        <button id="micBtn">üé§ Hold to talk</button>
        <span id="status" class="controls-label">mic: off</span>
      </div>
    </div>
  </div>

  <!-- RIGHT: transcript + feedback -->
  <div class="col col-right">
    <div class="panel">
      <h3>Dialogue transcript</h3>
      <p class="panel-subtitle">Conversation with the current seller persona.</p>
      <div id="dialogueTranscript" class="box box-chat"></div>

      <div class="row row-left" style="margin-top:10px;">
        <input id="textInput" type="text" class="text-input"
               placeholder="‚Ä¶or type here and click Send" />
      </div>
      <div class="row row-left" style="margin-top:6px;">
        <button id="confirmBtn">Send</button>
        <button id="clearBtn" class="btn-ghost">Clear</button>
        <button id="feedbackBtn" class="btn-ghost">üí¨ Give me feedback</button>
      </div>
    </div>

    <div id="feedbackPanel" class="panel" style="margin-top:12px; display:none;">
      <h3>Session feedback</h3>
      <p class="panel-subtitle">Automated coaching summary from the scoring agent.</p>

      <div class="score-layout" style="margin-top:12px;">
        <div class="score-main">
          <div id="scoreRing" class="score-ring">
            <div class="score-number">
              <span id="scoreRingValue">--</span>
              <span class="score-max">/100</span>
            </div>
            <div class="score-label" id="scoreRingLabel">Needs Improvement</div>
          </div>
          <p id="scoreSummary" class="score-summary">
            Click "Give me feedback" after a call to generate analysis.
          </p>
        </div>

        <div id="scoresBreakdown" class="score-bars" style="margin-top:6px;margin-bottom:10px;">
          <!-- JS injects rows -->
        </div>

        <div class="score-feedback-columns">
          <div class="score-column">
            <h4>What you did well</h4>
            <ul id="winsList"></ul>
          </div>
          <div class="score-column">
            <h4>What to improve next</h4>
            <ul id="nextStepsList"></ul>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <span>LUMI ‚Äì Sales Conversation Coach (prototype)</span>
  <span>¬© 2025 LUMI Demo Environment ‚Äì not an official Amazon product.</span>
</footer>

<script>
/* ========= Session handling ========= */
function getOrCreateSessionId() {
  const KEY = 'lumi_session_id';
  let id = localStorage.getItem(KEY);
  if (!id) {
    id = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(KEY, id);
  }
  return id;
}

let SESSION_ID = getOrCreateSessionId();
function resetSessionId() {
  const KEY = 'lumi_session_id';
  const id = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem(KEY, id);
  SESSION_ID = id;
}

/* ========= CONFIG ========= */
const N8N_WEBHOOK_URL = "https://charly811003642.app.n8n.cloud/webhook/seller-call-simulation";

/* ========= Foggy sphere ========= */
const canvas = document.getElementById('fog');
const ctx = canvas.getContext('2d');

function sizeCanvas(){
  const s = Math.min(520, Math.floor(window.innerWidth*0.9));
  canvas.width = s;
  canvas.height = s;
  canvas.style.width = s+'px';
  canvas.style.height = s+'px';
}
sizeCanvas();
window.addEventListener('resize', sizeCanvas);

let R = Math.min(canvas.width, canvas.height)*0.42;
let audioCtx, analyser, micStream, amp = 0;

function readAmplitude(){
  if (!analyser) return 0;
  const buf = new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(buf);
  let sum = 0;
  for (let i = 0; i < buf.length; i++){
    const v = (buf[i] - 128) / 128;
    sum += v * v;
  }
  return Math.min(1, Math.sqrt(sum / buf.length) * 3);
}

const blobs = Array.from({length: 24}, () => ({
  baseA: Math.random()*Math.PI*2,
  baseR: 0.18 + Math.random()*0.70,
  size:  0.10 + Math.random()*0.30,
  speed: (0.2 + Math.random()*0.6)*(Math.random()<0.5?-1:1),
  wobble: 0.15 + Math.random()*0.4
}));

function mix(a,b,t){ return a + (b-a)*t; }

let t0 = performance.now();
function draw(){
  requestAnimationFrame(draw);
  const t = (performance.now() - t0) / 1000;

  const fallback = 0.25 + 0.20 * Math.sin(t*1.2);
  const micVal = readAmplitude();
  const target = micVal || fallback;
  amp = amp * 0.85 + target * 0.15;

  const W = canvas.width, H = canvas.height;
  const CX = W/2, CY = H/2;
  const rNow = R * (1 + 0.15*amp);

  ctx.clearRect(0,0,W,H);

  ctx.save();
  ctx.beginPath();
  ctx.arc(CX,CY,rNow,0,Math.PI*2);
  ctx.clip();

  const baseGrad = ctx.createRadialGradient(CX,CY,rNow*0.15,CX,CY,rNow);
  baseGrad.addColorStop(0,'rgba(120,190,255,0.35)');
  baseGrad.addColorStop(1,'rgba(120,190,255,0)');
  ctx.fillStyle = baseGrad;
  ctx.fillRect(CX-rNow,CY-rNow,rNow*2,rNow*2);

  ctx.globalCompositeOperation='lighter';
  for (const b of blobs){
    const a  = b.baseA + b.speed*t + Math.sin(t*0.8 + b.baseA)*0.25*b.wobble;
    const rr = b.baseR * (1 + 0.06*Math.sin(t*0.9 + b.baseA));
    const x  = CX + Math.cos(a)*rr*(rNow*0.95);
    const y  = CY + Math.sin(a)*rr*(rNow*0.95);
    const rad= rNow*b.size*(1 + 0.45*amp);

    const cMix = Math.min(1, Math.max(0, rr+0.2));
    const rCol = Math.floor(mix(90,160,cMix));
    const gCol = Math.floor(mix(160,130,cMix));
    const bCol = 255;

    const g2 = ctx.createRadialGradient(x,y,rad*0.2,x,y,rad);
    g2.addColorStop(0,`rgba(${rCol},${gCol},${bCol}, ${0.22 + 0.45*amp})`);
    g2.addColorStop(1,`rgba(${rCol},${gCol},${bCol}, 0)`);
    ctx.fillStyle = g2;
    ctx.beginPath();
    ctx.arc(x,y,rad,0,Math.PI*2);
    ctx.fill();
  }
  ctx.globalCompositeOperation='source-over';
  ctx.restore();

  ctx.beginPath();
  ctx.arc(CX,CY,rNow,0,Math.PI*2);
  ctx.shadowBlur = 40 + amp*80;
  ctx.shadowColor='rgba(124,211,255,0.35)';
  ctx.strokeStyle='rgba(124,211,255,0.12)';
  ctx.lineWidth=2;
  ctx.stroke();
}
draw();

async function initMic(){
  if (!navigator.mediaDevices?.getUserMedia) return;
  if (!audioCtx){
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      analyser.smoothingTimeConstant = 0.8;
      src.connect(analyser);
    }catch(e){
      console.error('Mic init failed:', e);
    }
  }
}

/* ========= DOM refs ========= */
const statusEl = document.getElementById('status');
const micBtn = document.getElementById('micBtn');
const textInput = document.getElementById('textInput');
const confirmBtn = document.getElementById('confirmBtn');
const clearBtn = document.getElementById('clearBtn');
const feedbackBtn = document.getElementById('feedbackBtn');
const feedbackPanel = document.getElementById('feedbackPanel');
const dialogueEl = document.getElementById('dialogueTranscript');

const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const hintBtn = document.getElementById('hintBtn');
const answerBtn = document.getElementById('answerBtn');

const personaSelect = document.getElementById('personaSelect');
const topicSelect = document.getElementById('topicSelect');
const sphereWrapper = document.querySelector('.sphere-wrapper');
const sphereLogo = document.querySelector('.sphere-logo');

/* ========= Conversation rendering ========= */
let conversation = [];

function getPersonaKey(){
  const idx = personaSelect.selectedIndex;
  if (idx === 0) return 'persona1';
  if (idx === 1) return 'persona2';
  if (idx === 2) return 'persona3';
  if (idx === 3) return 'persona4';
  if (idx === 4) return 'persona5';
  if (idx === 5) return 'persona6';
  return 'persona1';
}
function getPersonaShort(){
  const opt = personaSelect.options[personaSelect.selectedIndex];
  return opt ? opt.text.split('‚Äì')[0].trim() : 'Seller';
}
function getDifficulty(){
  const active = document.querySelector('.difficulty-btn.active');
  return active ? active.dataset.level : 'easy';
}
function getTopic(){
  const opt = topicSelect.options[topicSelect.selectedIndex];
  return opt ? opt.text : '';
}

function renderTranscript(){
  dialogueEl.innerHTML = '';
  conversation.forEach(msg => {
    const wrap = document.createElement('div');
    wrap.className = 'msg';
    const roleDiv = document.createElement('div');
    roleDiv.className = 'msg-role ' + msg.role;
    roleDiv.textContent = msg.roleLabel;
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'msg-body';
    bodyDiv.textContent = msg.text;
    wrap.appendChild(roleDiv);
    wrap.appendChild(bodyDiv);
    dialogueEl.appendChild(wrap);
  });
  dialogueEl.scrollTop = dialogueEl.scrollHeight;
}

/* ========= Speech synthesis ========= */
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){
    console.warn('TTS failed', e);
  }
}

/* ========= n8n helpers ========= */
async function callN8N(payload){
  try{
    const res = await fetch(N8N_WEBHOOK_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok){
      console.error('n8n error status', res.status);
      return { reply:`n8n error: ${res.status}` };
    }
    return await res.json();
  }catch(e){
    console.error('n8n fetch error', e);
    return { reply:'n8n fetch error' };
  }
}

async function sendMessageToPersona(text, mode='answer'){
  const amLabel = 'You ‚Äì Account Manager';
  conversation.push({ role:'am', roleLabel:amLabel, text });
  renderTranscript();

  confirmBtn.disabled = true;
  const payload = {
    sessionId: SESSION_ID,
    text,
    persona: getPersonaKey(),
    difficulty: getDifficulty(),
    topic: getTopic(),
    mode
  };
  const data = await callN8N(payload);
  const msg = data.reply || data.answer || data.message || '(no reply)';
  const lumiLabel = `Seller ‚Äì LUMI (${getPersonaShort()})`;
  conversation.push({ role:'lumi', roleLabel:lumiLabel, text:msg });
  renderTranscript();
  speak(msg);
  confirmBtn.disabled = false;
}

/* === scoring data extraction (handles ```json fences) === */
/* === scoring data extraction (handles arrays + ```json fences) === */
function extractScoreData(raw) {
  console.log('raw feedback from n8n:', raw);

  // If n8n returned an array like [ { reply: "```json\n{...}\n```" } ]
  if (Array.isArray(raw) && raw.length > 0) {
    raw = raw[0];
  }

  // Already a structured object
  if (raw && typeof raw === 'object') {
    if (raw.feedback && typeof raw.feedback === 'object') {
      return raw.feedback;
    }
    if (typeof raw.overall_score === 'number') {
      return raw;
    }
  }

  // Find the text field that actually holds the JSON string
  let text = null;
  if (raw && typeof raw === 'object') {
    if (typeof raw.reply === 'string') text = raw.reply;
    else if (typeof raw.output === 'string') text = raw.output;
  } else if (typeof raw === 'string') {
    text = raw;
  }

  if (!text) {
    console.warn('No reply/output string found in scoring payload:', raw);
    return null;
  }

  let s = text.trim();

  // Strip ```json ... ``` fences if present
  if (s.startsWith('```')) {
    // Remove first line (``` or ```json)
    const firstNewline = s.indexOf('\n');
    if (firstNewline !== -1) {
      s = s.slice(firstNewline + 1);
    }
    // Remove trailing ```
    const lastFence = s.lastIndexOf('```');
    if (lastFence !== -1) {
      s = s.slice(0, lastFence);
    }
    s = s.trim();
  }

  // As a safety net, cut to the substring between the first { and last }
  const firstBrace = s.indexOf('{');
  const lastBrace  = s.lastIndexOf('}');
  if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
    s = s.slice(firstBrace, lastBrace + 1);
  }

  try {
    const parsed = JSON.parse(s);
    console.log('parsed score data:', parsed);
    return parsed;
  } catch (e) {
    console.error('Could not parse score JSON:', e, s);
    return null;
  }
}

async function requestFeedback(){
  feedbackPanel.style.display = 'block';

  const summaryEl = document.getElementById('scoreSummary');
  if (summaryEl) summaryEl.textContent = 'Scoring session‚Ä¶';

  const payload = {
    sessionId: SESSION_ID,
    persona: 'score',
    mode: 'score',
    text: 'Please score the current session and return feedback.'
  };

  const raw = await callN8N(payload);
  const scoreData = extractScoreData(raw);

  if (!scoreData) {
    if (summaryEl) {
      summaryEl.textContent = 'Could not parse scoring data (check console for details).';
    }
    return;
  }

  updateScoreUI(scoreData);
}


/* ========= SCORE UI UPDATE ========= */
function updateScoreUI(scoreData){
  const overall   = Number(scoreData.overall_score ?? 0);
  const clamped   = Math.max(0, Math.min(100, overall));

  const ring      = document.getElementById('scoreRing');
  const ringValue = document.getElementById('scoreRingValue');
  const ringLabel = document.getElementById('scoreRingLabel');
  const summaryEl = document.getElementById('scoreSummary');

  if (ring) ring.style.setProperty('--score', clamped);
  if (ringValue) ringValue.textContent = clamped.toString();
  if (ringLabel) ringLabel.textContent = scoreData.rating || '';
  if (summaryEl) summaryEl.textContent = scoreData.summary || '';

  // sub-scores
  const breakdown = document.getElementById('scoresBreakdown');
  if (breakdown && Array.isArray(scoreData.dimensions)) {
    breakdown.innerHTML = '';
    scoreData.dimensions.forEach(dim => {
      const percent = dim.max_score ? Math.round((dim.score / dim.max_score) * 100) : 0;
      const row = document.createElement('div');
      row.className = 'score-row';
      row.innerHTML = `
        <div class="score-row-label">${dim.name}</div>
        <div class="score-bar">
          <div class="score-bar-track">
            <div class="score-bar-fill" style="width:${percent}%;"></div>
          </div>
        </div>
        <div class="score-row-value">${dim.score} / ${dim.max_score}</div>
      `;
      breakdown.appendChild(row);
    });
  }

  // wins & next steps
  const winsList = document.getElementById('winsList');
  const nextList = document.getElementById('nextStepsList');

  if (winsList) {
    winsList.innerHTML = '';
    (scoreData.wins || []).forEach(w => {
      const li = document.createElement('li');
      li.textContent = w;
      winsList.appendChild(li);
    });
  }

  if (nextList) {
    nextList.innerHTML = '';
    (scoreData.next_steps || []).forEach(n => {
      const li = document.createElement('li');
      li.textContent = n;
      nextList.appendChild(li);
    });
  }
}

function resetScoreUI() {
  const ring      = document.getElementById('scoreRing');
  const ringValue = document.getElementById('scoreRingValue');
  const ringLabel = document.getElementById('scoreRingLabel');
  const summaryEl = document.getElementById('scoreSummary');
  const breakdown = document.getElementById('scoresBreakdown');
  const winsList  = document.getElementById('winsList');
  const nextList  = document.getElementById('nextStepsList');

  if (ring) ring.style.setProperty('--score', 0);
  if (ringValue) ringValue.textContent = '--';
  if (ringLabel) ringLabel.textContent = 'Needs Improvement';
  if (summaryEl) {
    summaryEl.textContent = 'Click "Give me feedback" after a call to generate analysis.';
  }
  if (breakdown) breakdown.innerHTML = '';
  if (winsList) winsList.innerHTML = '';
  if (nextList) nextList.innerHTML = '';
}

/* ========= STT: hold-to-talk ========= */
let rec, recognizing = false;

micBtn.addEventListener('mousedown', async () => {
  await initMic();
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){
    statusEl.textContent = 'mic: ready (no browser STT ‚Äî type & Send)';
    return;
  }
  rec = new SR();
  rec.lang = 'en-US';
  rec.interimResults = true;
  rec.continuous = true;
  textInput.value = '';
  rec.onstart = () => {
    statusEl.textContent = 'mic: listening‚Ä¶';
    recognizing = true;
  };
  rec.onresult = (e) => {
    let finalText = '';
    let interim = '';
    for (let i=0;i<e.results.length;i++){
      const r = e.results[i];
      if (r.isFinal) finalText += r[0].transcript + ' ';
      else interim += r[0].transcript;
    }
    const combined = (finalText + interim).trim();
    textInput.value = combined;
  };
  rec.onerror = () => {
    statusEl.textContent = 'mic: error';
  };
  rec.onend = () => {
    recognizing = false;
    statusEl.textContent = 'mic: ready';
  };
  rec.start();
});

window.addEventListener('mouseup', () => {
  if (rec && recognizing) rec.stop();
});

/* ========= Controls ========= */
confirmBtn.addEventListener('click', () => {
  const t = (textInput.value || '').trim();
  if (!t) return;
  textInput.value = '';
  sendMessageToPersona(t, 'answer');
});

feedbackBtn.addEventListener('click', () => {
  requestFeedback();
});

// Difficulty pills
document.querySelectorAll('.difficulty-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});

// Play / Pause / Restart ‚Äì control TTS + reset
playBtn.addEventListener('click', () => {
  if (speechSynthesis.paused) {
    speechSynthesis.resume();
  }
});

pauseBtn.addEventListener('click', () => {
  if (speechSynthesis.speaking && !speechSynthesis.paused) {
    speechSynthesis.pause();
  }
});

clearBtn.addEventListener('click', () => {
  conversation = [];
  renderTranscript();
  feedbackPanel.style.display = 'none';
  resetScoreUI();
});

restartBtn.addEventListener('click', () => {
  speechSynthesis.cancel();
  resetSessionId();
  conversation = [];
  renderTranscript();
  feedbackPanel.style.display = 'none';
  resetScoreUI();
});

// Hint / Answer-for-me buttons
hintBtn.addEventListener('click', () => {
  sendMessageToPersona('[Hint request]', 'hint');
});

answerBtn.addEventListener('click', () => {
  sendMessageToPersona('[Auto answer request]', 'autoAnswer');
});

/* ========= Menu toggle ========= */
const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');

menuBtn.addEventListener('click', () => {
  menuPanel.classList.toggle('open');
});

document.addEventListener('click', (e) => {
  if (!menuPanel.contains(e.target) && !menuBtn.contains(e.target)){
    menuPanel.classList.remove('open');
  }
});

/* ========= INTRO ANIMATION ========= */
window.addEventListener('load', () => {
  sphereWrapper.classList.add('intro-pulse');
  setTimeout(() => {
    sphereLogo.style.opacity = '0';
    document.body.classList.remove('intro');
  }, 4000);
});
</script>
</body>
</html>
